<html>
<body>

<head>
<title>IF Flightplan Tools | Editor</title>

<link href="all.css" rel="stylesheet">
<style>

body {
  font-family: Helvetica, sans-serif;
  background-color: #1A1D21;
  color: white;
  }

* {box-sizing: border-box;}


.header {
  overflow: hidden;
  background-color: #002642;
  padding: 20px 10px;
  border-bottom: 5px solid;
  border-bottom-color: #E59500;
  border-radius: 20px;
}

.header a {
  float: left;
  color: white;
  text-align: center;
  padding: 12px;
  text-decoration: none;
  font-size: 18px; 
  line-height: 25px;
  border-radius: 4px;
  height: 50px;
}

.header a.logo {
  font-size: 35px;
  font-weight: bold;
  color: white;
}

.header a:hover {
  background-color: #002642;
  border-bottom: 5px solid;
  border-bottom-color: #E59500;
}

.header a.active {
  background-color: #1A1D21;
  color: white;
}

.header-right {
  float: right;
}

@media screen and (max-width: 500px) {
  .header a {
    float: none;
    display: block;
    text-align: left;
  }
  
  .header-right {
    float: none;
  }
}


#fpltable {
  border-collapse: collapse;
}

td, th {
  border: 2px solid;
  border-color: black;
  padding: 8px;
}

#fpltable tr:nth-child(even){
background-color: #384147;
}


#fpltable th {
  padding-top: 12px;
  padding-bottom: 12px;
  text-align: center;
  background-color: #002642;
  color: white;
}

/* The popup form - hidden by default */
.form-popup {
  display: none;
  position: fixed;
  bottom: 0;
  right: 15px;
  border: 3px solid black;
  z-index: 9;
  background-color: #1A1D21;
  color: white;
}

/* Add styles to the form container */
.form-container {
  max-width: 300px;
  padding: 10px;
  background-color: #1A1D21;
}

/* Full-width input fields */
.form-container input[type=text], .form-container input[type=number] {
  width: 100%;
  padding: 10px;
  margin: 5px 0 22px 0;
  border: none;
  background: #f1f1f1;
}

#lat {
  width: 49%;
  padding: 10px;
  margin: 5px 0 22px 0;
  border: none;
  background: #48555E;
  color: white;
  float: left;
  clear: left;
  font-size: 14;
  }
  
#lon {
  width: 49%;
  padding: 10px;
  margin: 5px 0 22px 0;
  border: none;
  background: #48555E;
  color: white;
  float: right;
  clear: right;
  font-size: 14;
  }
  
#lonl {
  width: 49%;
  float: right;
  clear: right;
  text-align: left;
  }

#latl {
  width: 49%;
  float: left;
  clear: left;
  text-align: left;
  }
  
#id {
  width: 49%;
  padding: 10px;
  margin: 5px 0 22px 0;
  border: none;
  background: #48555E;
  color: white;
  float: left;
  clear: left;
  font-size: 14;
  }
  
#alt {
  width: 49%;
  padding: 10px;
  margin: 5px 0 22px 0;
  border: none;
  background: #48555E;
  color: white;
  float: right;
  clear: right;
  font-size: 14;
  }
  
#altl {
  width: 49%;
  float: right;
  clear: right;
  text-align: left;
  }

#idl {
  width: 49%;
  float: left;
  clear: left;
  text-align: left;
  }
  
#exitheadingl {
  width: 49%;
  float: left;
  clear: left;
  text-align: left;
  }
  
#exittickl {
  width: 49%;
  float: right;
  clear: right;
  text-align: left;
  }

#exitheading {
  width: 49%;
  padding: 10px;
  margin: 5px 0 22px 0;
  border: none;
  background: #48555E;
  float: left;
  clear: left;
  font-size: 14;
  }  
    
#entryl {
  width: 49%;
  float: left;
  clear: left;
  text-align: left;
  }
  
#pointsl {
  width: 49%;
  float: right;
  clear: right;
  text-align: left;
  }

#entry {
  width: 49%;
  padding: 10px;
  margin: 5px 0 22px 0;
  border: none;
  background: #48555E;
  float: left;
  clear: left;
  font-size: 14;
  }  
  
#points {
  width: 49%;
  padding: 10px;
  margin: 5px 0 22px 0;
  border: none;
  background: #48555E ;
  float: right;
  clear: right;
  font-size: 14;
  }  
  
  
/* Set a style for the submit/login button */
.form-container .btn {
  background-color: #4CAF50;
  color: white;
  padding: 16px 20px;
  border: none;
  cursor: pointer;
  width: 100%;
  margin-top: 10px;
  opacity: 0.9;
  font-size: 15px;
}

/* Add a red background color to the cancel button */
.form-container .cancel {
  background-color: red;
}

.closebtn {
/*background-color: red;*/
  color: red;
  float: right;
  padding: 5px;
  border: none;
  cursor: pointer;
  /*margin-bottom:10px;*/
  opacity: 0.9;
  /*width: 25px;
  height: 25px;*/
  font-size: 30px;
}
.closebtn:hover {
opacity: 0.8;
}


/* Add some hover effects to buttons */
.form-container .btn:hover, .open-button:hover {
  opacity: 0.8;
}

.grid-container {
  display: inline-grid;
  grid-template-columns: auto auto auto;
  grid-template-rows: auto auto auto;
  grid-column-gap: 5px;
  width: 100%;
}

.grid-container > div {
  width: 90px;
  height: 25px;
}

.gridarc {
grid-column-start: 2;
grid-row: 1 / span 3
}

.btngrid {
	background-color: #ffad33;
  color: black;
  border: none;
  cursor: pointer;
  opacity: 1;
  width: 100%;
  height: 100%;
  font-size: 25px;
  padding: 1px 0;
}

.btnarcgrid {
	background-color: #ffad33;
  color: black;
  border: none;
  cursor: pointer;
  opacity: 1;
  font-size: 20px;
  padding: 1px 0;
  height: 75px;
}
  
.btngrid:hover, .btnarcgrid:hover {
opacity: 0.8;
}

.labelgrid {
	background-color: #ffad33;
  color: black;
  border: none;
  opacity: 1;
  text-align: center;
  line-height: 25px;
}


/*Checkbox Style*/
/* The container */
.container {
  display: block;
  position: relative;
  padding-left: 20px;
  margin-right:70px;
  margin-top: 10px;
  cursor: pointer;
  font-size: 22px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  float: right;
  clear: right;
}

/* Hide the browser's default checkbox */
.container input {
  position: absolute;
  opacity: 0;
  cursor: pointer;
  height: 0;
  width: 0;
}

/* Create a custom checkbox */
.checkmark {
  position: absolute;
  top: 0;
  left: 0;
  height: 25px;
  width: 25px;
  background-color: #48555E;
}

/* On mouse-over, add a grey background color */
.container:hover input ~ .checkmark {
  background-color: #002642;
}

/* When the checkbox is checked, add a blue background */
.container input:checked ~ .checkmark {
  background-color: #2196F3;
}

/* Create the checkmark/indicator (hidden when not checked) */
.checkmark:after {
  content: "";
  position: absolute;
  display: none;
}

/* Show the checkmark when checked */
.container input:checked ~ .checkmark:after {
  display: block;
}

/* Style the checkmark/indicator */
.container .checkmark:after {
  left: 9px;
  top: 5px;
  width: 5px;
  height: 10px;
  border: solid white;
  border-width: 0 3px 3px 0;
  -webkit-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  transform: rotate(45deg);
}

#fplDownloads {
display: none;
}

.newfplbtn {
  background-color: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
  opacity: 1;
  font-size: 20px;
  padding: 5px;
  margin: 5px;
  height: 30px;
  width: 170px;
  border-radius: 10px;
  line-height: 1.5px;
  font-weight: 700;
}

.newfplbtn:hover {
opacity: 0.8;
}

.fplbtn {
	width: 0.1px;
	height: 0.1px;
	opacity: 0;
	overflow: hidden;
	position: absolute;
	z-index: -1;
}

.fplbtn, .fplbtnl {
    font-size: 20px;
    font-weight: 700;
    color: white;
    background-color: #ffad33;
    display: inline-block;
    width: 170px;
	height: 30px;
	margin:5px;
	padding: 5px;
	border-radius: 10px;
	text-align: center;
	line-height: 1.5px;
}

.fplbtn:focus, .fplbtnl:focus,
.fplbtn:hover, .fplbtnl:hover {
    background-color: #ff9900;
}

.fplbtn, .fplbtnl {
	cursor: pointer; /* "hand" cursor */
}

.fplInputs {
padding: 5px;
}

#filenamel {
font-size: 18px;
font-weight: 700;
}

#filename {
font-size: 15px;
}

.editbtn {
 border-radius: 15px;
 font-size: 15px;
 margin:0px;
 /*
 border-top-color: white;
 border-left-color: white;
 border-right-color: #74F277;
 border-bottom-color: #74F277;
 */
 border-color: #002642;
 background-color: #002642;
 color: white;
}

.editbtn:hover {
border-color: #e59500;
}

#filename {
background-color:#48555E ;
color: white;
border: 2px solid #48555E ;
}

/*<button onclick="getlatlon()">Get LatLon from PMDG</button>*/
</style>
</head>

<div class="header">
  <a href="#default" class="logo">IF Flightplan Tools</a>
  <div class="header-right">
    <a href="index.html">Home</a>
    <a class="active" href="editor">FPL Editor</a>
    <a href="kml">KML to FPL</a>
  </div>
</div>
<div id = "fplInputs">
<h1 class="fplInputs">Fightplan Editor</h1>
<p class="fplInputs">This webpage will allow you to edit fpl files for Infinite Flight or create a new flight plan. <br>Pick an option below!</p>
<input type="file" name = "fpl" id="fpl" class="fplbtn">
<label for="fpl" name="fpl" class="fplbtnl"><i class="fas fa-upload"></i> Choose a file</label>
<button class="newfplbtn" onclick="createNew()"><i class="fas fa-plus-square"></i> Create New</button>
</p>
</div>

<div id = "fplDownloads">
<p><label id = "filenamel" for ="filename">Filename:</label><input id = "filename" type="text" name="filename" id=filename value="flightplan"><br>
<button class="newfplbtn" onclick="exportfpl()"><i class="fas fa-download"></i> Download</button></p>
</div>


<div class="form-popup" id="WptForm">
  <form class="form-container">
  <span class="closebtn"><i class="fas fa-window-close" onclick="closeForm()"></i></span>
    <h1 id="wptnum">Waypoint # N/A</h1>
	
    <label id ="idl" for="id" class = ><b>ID</b></label>
    <label id ="altl" for="alt"><b>Altitude</b></label><br>
	
	<input type="text" name="id" id="id">
    <input type="number" name="alt" id="alt">

    <label id ="latl" for="lat"><b>Latitude</b></label>
    <label id ="lonl"  for="lon"><b>Longitude</b></label><br>
    
    <input  type="number" name="lat" id="lat">
    <input  type="number" name="lon" id="lon">
    
    
    
    <div class="grid-container">
    	<div><button type="button" class="btngrid" onclick = "moveUp()"><i class="fas fa-angle-up"></i></button></div>
    	<div class = "gridarc"><button type="button" class="btnarcgrid" onclick = "openArc()">Arc to next</button></div>
        <div><button type="button" class="btngrid" onclick = "Createabove()"><i class="fas fa-angle-up"></i></button></div>
    	<div class="labelgrid">Move</div>
    	<div class="labelgrid">Insert</div>
   		<div><button type="button" class="btngrid" onclick = "moveDown()"><i class="fas fa-angle-down"></i></button></div>
    	<div><button type="button" class="btngrid" onclick = "Createbelow()"><i class="fas fa-angle-down"></i></button></div>
     </div>
  
    
   	<button type="button" class="btn" onclick = "savetable()"><b>Save</b></button>
    <button type="button" class="btn cancel" onclick="Deleterow()"><b>Delete</b></button>
        
  </form>
</div>

<div class="form-popup" id="ArcForm">
  <form class="form-container">
  <span class="closebtn"><i class="fas fa-window-close" onclick="closeArc()"></i></span>
    <h1 id="wptnum">Arc to Next</h1>
	
	<label id ="exitheadingl"  for="exitheading" class = "labell"><b>Last Exit heading</b></label>
    <label id ="exittickl" for="exittick" class = "labler"><b>Use exit heading?</b></label><br>
    
    
    <input  type="number" name="exitheading" id="exitheading" class = "inputl">
    <label class="container">
  <input id= "exittick" type="checkbox" onclick = "checkforexit()">
  <span class="checkmark"></span>
</label>
	
    <label id ="entryl" for="entry" class = "labell"><b>Entry Heading (True)</b></label>
    <label id ="pointsl" for="points" class = "labelr"><b>Points (1 per nm recommended)</b></label><br>
	
	<input type="number" name="entry" id="entry" class = "inputl">
    <input type="number" name="points" id="points" value = "10" class = "inputr">

    
   	<button type="button" class="btn" onclick = "Arc()"><b>Add Arc</b></button>
    <button type="button" class="btn cancel" onclick="closeArcOpen()"><b>Cancel</b></button>
        
  </form>
</div>

<table id="fpltable"></table>


<script>



const println = (msg) => {
  console.log(msg);
}

document.getElementById('fpl').addEventListener('change', readFileAsString)

var n 

function createNew(){
newfpladded()
var table = "<tr><th>Name</th><th>Latitude</th><th>Longitude</th><th>Altitude</th><th>Type</th><th></th></tr>";
document.getElementById("fpltable").innerHTML = table
document.getElementById("wptnum").innerHTML = "Waypoint #0"
Createbelow()
}

function newfpladded() {
  document.getElementById("fplDownloads").style.display = "block";
  document.getElementById("fplInputs").style.display = "none";
}

function getlatlon(){
var input = prompt("Enter fix data","");
var inputarray = input.split(" ");
id = inputarray[1];
var latD = Number(inputarray[5])/60;
if(inputarray[3]== "S"){
var lat = "-";
lat += inputarray[4];
lat = Number(lat) - Number(latD)
}
else{
var lat = "";
lat += inputarray[4];
lat = Number(lat) + Number(latD)
}
lat = lat.toFixed(7)


if(inputarray[6]== "W"){var lon = "-"}
else{var lon = ""}
lon += inputarray[7]
var lonD = (Number(inputarray[8])/60)
lonD = Number(lonD).toFixed(0)
lon += "."
lon += lonD

var lonD = Number(inputarray[8])/60;
if(inputarray[6]== "W"){
var lon = "-";
lon += inputarray[7];
lon = Number(lon) - Number(lonD)
}
else{
var lon = "";
lon += inputarray[7];
lon = Number(lon) + Number(lonD)
}
lon = lon.toFixed(7)

console.log(id)
console.log(lat)
console.log(lon)

document.getElementById("id").value = id
document.getElementById("lat").value = lat
document.getElementById("lon").value = lon
}

function checkforexit(){
if (document.getElementById('exittick').checked == true){
if (document.getElementById('exitheading').value == ""){
alert("You must have an exit heading value to tick this box")
document.getElementById('exittick').checked = false;
}
}
}

function openArc(){
var o = document.getElementById("wptnum").innerHTML.match(/(\d+)/); 
var r = Number(o[0]);
var trows = Number(document.getElementById("fpltable").rows.length)
trows = trows - 1
if (r == trows) {alert("Can't add arc to last waypoint")}
else{
if (r == 1){alert("First Waypoint, can't autofill entry heading")}
else{

var pr = r - 1
var lat0 = Number(document.getElementById("fpltable").rows[pr].cells[1].innerHTML);
var lat1 = Number(document.getElementById("fpltable").rows[r].cells[1].innerHTML);
var lon0 = Number(document.getElementById("fpltable").rows[pr].cells[2].innerHTML);
var lon1 = Number(document.getElementById("fpltable").rows[r].cells[2].innerHTML);

// find the distance and heading to the final fix
dh = DistHeading(lat0,lon0,lat1,lon1);
var headingToFinal=dh[1];
document.getElementById("entry").value = headingToFinal.toFixed(0)
}

closeForm()
 document.getElementById("ArcForm").style.display = "block";
}
}

function Arc(){

var o = document.getElementById("wptnum").innerHTML.match(/(\d+)/); 
var r = Number(o[0]);
var nr = Number(r) + 1;

var wptid = document.getElementById("fpltable").rows[r].cells[0].innerHTML

var lat0 = Number(document.getElementById("fpltable").rows[r].cells[1].innerHTML);
var lat1 = Number(document.getElementById("fpltable").rows[nr].cells[1].innerHTML);
var lon0 = Number(document.getElementById("fpltable").rows[r].cells[2].innerHTML);
var lon1 = Number(document.getElementById("fpltable").rows[nr].cells[2].innerHTML);

if (document.getElementById('exittick').checked == true){
var heading = Number(document.getElementById("exitheading").value);
}
else{
var heading = Number(document.getElementById("entry").value);
}

var points = Number(document.getElementById("points").value);
var points = points + 1

var lonscale = LonMultiplier((lat0+lat1)/2);
//println("LonMultiplier="+lonscale);
var dx = (lon1-lon0)*lonscale;
var dy = lat1-lat0;
//println(dx + "," + dy);

// find the distance and heading to the final fix
dh = DistHeading(lat0,lon0,lat1,lon1);

var headingToFinal=dh[1];
var distToFinal=dh[0];


// verify final fix with distance and heading from initial fix
check = NewPoint(lat0,lon0,headingToFinal,distToFinal);



// find the arc radius
alpha = FixHeading(90 - Math.abs(heading - headingToFinal))%360;
//println("alpha="+alpha)
var arcR = Math.abs(dh[0]/(2*Math.cos(alpha*Math.PI/180)));
//println("Arc Radius="+arcR)

// find lat lon of arc center
// first determine the direction
var dir1 = Number(heading) - 90;
var dir2 = Number(heading) + 90;
var headingToCenter = dir2;
var turnLeft = false;
if (AngleBetween(headingToFinal,dir1)<AngleBetween(headingToFinal,dir2))
{
  headingToCenter=dir1;
  turnLeft=true;
  //println("turning left");
}
var arcCenterDec = NewPoint(lat0,lon0,headingToCenter,arcR);
var initialArcHeading = FixHeading(headingToCenter-180);


// find swept angle and setup increment
var headingfixangle=AngleBetween(heading,headingToFinal);

var arcAngle=2*(90-AngleBetween(initialArcHeading,headingToFinal+180));
if (headingfixangle>90)
{
  //println("obtuse angle between heading & fix path")
  arcAngle=2*(90+AngleBetween(initialArcHeading,headingToFinal+180));
}
else
// *********************************** DO NOT DELETE **************************************
  println("acute angle between heading & fix path")

if (turnLeft == true) {
 var exitheadingT = heading - arcAngle
}
else{
var exitheadingT = heading + arcAngle
}

if (exitheadingT >360) {exitheadingT = exitheadingT - 360};
if (exitheadingT <0) {exitheadingT = exitheadingT + 360};

exitheadingT = exitheadingT.toFixed(0);

document.getElementById("exitheading").value = exitheadingT

var deltaAngle = arcAngle/points;
var initialArcangle = FixHeading(headingToCenter+180);

var decPoints = [];
if (turnLeft)
{
  var lastAngle = initialArcangle-arcAngle-deltaAngle+1;

  for (h= initialArcangle;h>lastAngle;h-=deltaAngle)
  {
    var arcPoint = NewPoint(arcCenterDec[0],arcCenterDec[1],h,arcR);
    decPoints.push(arcPoint);
   
  }
}
else
{
  var lastAngle = initialArcangle +arcAngle+deltaAngle-1;
  for (h= initialArcangle;h<lastAngle;h+=deltaAngle)
  {
    var arcPoint = NewPoint(arcCenterDec[0],arcCenterDec[1],h,arcR);
    decPoints.push(arcPoint);
    //print(" ")
  }
}

//println("Decimal fixes...");
for (index=1;index<decPoints.length - 1;index++)
{
  var lat = decPoints[index][0].toFixed(4);
  var lon = decPoints[index][1].toFixed(4);
  var id = wptid + "-" + index
  console.log(id,lat,lon)
  var arcr = r + index
    var table = document.getElementById("fpltable");
  var row = table.insertRow(arcr);
  var cell1 = row.insertCell(0);
  var cell2 = row.insertCell(1);
  var cell3 = row.insertCell(2);
  var cell4 = row.insertCell(3);
  var cell5 = row.insertCell(4);
  var cell6 = row.insertCell(5);
  cell1.innerHTML = id
  cell2.innerHTML = lat
  cell3.innerHTML = lon
  cell4.innerHTML = ""
  cell5.innerHTML = "USER"
  cell6.innerHTML = "<button onclick= showEditor(" + r +") class = editbtn ><i class='fas fa-edit'></i> Edit</button>";
}
updatetable()
closeArcOpen()
}

function closeArc(){
 document.getElementById("ArcForm").style.display = "none";
}

function closeArcOpen(){
 document.getElementById("ArcForm").style.display = "none";
 openForm()
}

function openForm() {
  document.getElementById("WptForm").style.display = "block";
}

function closeForm() {
  document.getElementById("WptForm").style.display = "none";
}

function updatetable(){
var trows = document.getElementById("fpltable").rows.length

r = 1
for (r = 1; r < trows; r++){

document.getElementById("fpltable").rows[r].cells[5].innerHTML = "<button onclick= showEditor(" + r +") class = editbtn ><i class='fas fa-edit'></i> Edit</button>";
}
}

function showEditor(r){
var id = document.getElementById("fpltable").rows[r].cells[0].innerHTML
var lat = document.getElementById("fpltable").rows[r].cells[1].innerHTML
var lon = document.getElementById("fpltable").rows[r].cells[2].innerHTML
var alt = document.getElementById("fpltable").rows[r].cells[3].innerHTML
document.getElementById("wptnum").innerHTML = "Waypoint #" + r
document.getElementById("id").value = id
document.getElementById("alt").value = alt
document.getElementById("lat").value = lat
document.getElementById("lon").value = lon
openForm()
}

function savetable(){

var o = document.getElementById("wptnum").innerHTML.match(/(\d+)/); 
var r = o[0];
//console.log(r);

var tid = document.getElementById("fpltable").rows[r].cells[0].innerHTML
var tlat = document.getElementById("fpltable").rows[r].cells[1].innerHTML
var tlon = document.getElementById("fpltable").rows[r].cells[2].innerHTML
var type = document.getElementById("fpltable").rows[r].cells[4].innerHTML

var id = document.getElementById("id").value;
var lat = document.getElementById("lat").value;
var lon = document.getElementById("lon").value;
var alt = document.getElementById("alt").value;

var changed = false

if (tid != id){changed = true}
if (tlat != lat){changed = true}
if (tlon != lon){changed = true}
if (changed == true){type = "USER"}

document.getElementById("fpltable").rows[r].cells[0].innerHTML = id;
document.getElementById("fpltable").rows[r].cells[1].innerHTML = lat;
document.getElementById("fpltable").rows[r].cells[2].innerHTML = lon;
document.getElementById("fpltable").rows[r].cells[3].innerHTML = alt;
document.getElementById("fpltable").rows[r].cells[4].innerHTML = type;
document.getElementById("fpltable").rows[r].cells[5].innerHTML = "<button onclick= showEditor(" + r +") class = editbtn ><i class='fas fa-edit'></i> Edit</button>";
closeForm()
}

function moveUp() {

var o = document.getElementById("wptnum").innerHTML.match(/(\d+)/); 
var r = Number(o[0])
console.log(r)
if (r > 1) {

var id = document.getElementById("id").value;
var lat = document.getElementById("lat").value;
var lon = document.getElementById("lon").value;
var alt = document.getElementById("alt").value;
var type = document.getElementById("fpltable").rows[r].cells[4].innerHTML

r = r - 1

  var table = document.getElementById("fpltable");
  var row = table.insertRow(r);
  var cell1 = row.insertCell(0);
  var cell2 = row.insertCell(1);
  var cell3 = row.insertCell(2);
  var cell4 = row.insertCell(3);
  var cell5 = row.insertCell(4);
  var cell6 = row.insertCell(5);
  cell1.innerHTML = id
  cell2.innerHTML = lat
  cell3.innerHTML = lon
  cell4.innerHTML = alt
  cell5.innerHTML = type
  cell6.innerHTML = "<button onclick= showEditor(" + r +") class = editbtn ><i class='fas fa-edit'></i> Edit</button>";
document.getElementById("fpltable").deleteRow(r + 2)
updatetable()
showEditor(r)
}
else{alert("You've reached the top, congratulations!")}
}

function moveDown() {

var o = document.getElementById("wptnum").innerHTML.match(/(\d+)/); 
var r = Number(o[0])
var trows = document.getElementById("fpltable").rows.length
trows = trows - 1
if (r < trows) {

var id = document.getElementById("id").value;
var lat = document.getElementById("lat").value;
var lon = document.getElementById("lon").value;
var alt = document.getElementById("alt").value;
var type = document.getElementById("fpltable").rows[r].cells[4].innerHTML

r = r + 2


  var table = document.getElementById("fpltable");
  var row = table.insertRow(r);
  var cell1 = row.insertCell(0);
  var cell2 = row.insertCell(1);
  var cell3 = row.insertCell(2);
  var cell4 = row.insertCell(3);
  var cell5 = row.insertCell(4);
  var cell6 = row.insertCell(5);
  cell1.innerHTML = id
  cell2.innerHTML = lat
  cell3.innerHTML = lon
  cell4.innerHTML = alt
  cell5.innerHTML = type
  cell6.innerHTML = "<button onclick= showEditor(" + r +") class = editbtn ><i class='fas fa-edit'></i> Edit</button>";
document.getElementById("fpltable").deleteRow(r - 2)
updatetable()
r = r - 1
showEditor(r)
}
else{alert("You've reached the bottom, congratulations!")}
}

function Createabove(r) {
var o = document.getElementById("wptnum").innerHTML.match(/(\d+)/); 
var r = Number(o[0])


  var table = document.getElementById("fpltable");
  var row = table.insertRow(r);
  var cell1 = row.insertCell(0);
  var cell2 = row.insertCell(1);
  var cell3 = row.insertCell(2);
  var cell4 = row.insertCell(3);
  var cell5 = row.insertCell(4)
  var cell6 = row.insertCell(5);
  cell1.innerHTML = ""
  cell2.innerHTML = ""
  cell3.innerHTML = ""
  cell4.innerHTML = ""
  cell5.innerHTML = "USER"
  cell6.innerHTML = "<button onclick= showEditor(" + r +") class = editbtn ><i class='fas fa-edit'></i> Edit</button>";
updatetable()
showEditor(r)
}

function Createbelow(r) {
var o = document.getElementById("wptnum").innerHTML.match(/(\d+)/); 
var r = Number(o[0])
r = r + 1
//console.log(r)


  var table = document.getElementById("fpltable");
  var row = table.insertRow(r);
  var cell1 = row.insertCell(0);
  var cell2 = row.insertCell(1);
  var cell3 = row.insertCell(2);
  var cell4 = row.insertCell(3);
  var cell5 = row.insertCell(4)
  var cell6 = row.insertCell(5);
  cell1.innerHTML = ""
  cell2.innerHTML = ""
  cell3.innerHTML = ""
  cell4.innerHTML = ""
  cell5.innerHTML = "USER"
  cell6.innerHTML = "<button onclick= showEditor(" + r +") class = editbtn ><i class='fas fa-edit'></i> Edit</button>";
updatetable()
showEditor(r)
}

function Deleterow(r) {
var o = document.getElementById("wptnum").innerHTML.match(/(\d+)/); 
var r = o[0]

var trows = document.getElementById("fpltable").rows.length
console.log(trows)
if (trows >= 3){
  document.getElementById("fpltable").deleteRow(r);
  updatetable()
  closeForm()
}
  else{
  alert("Sorry, you can't remove the last remaining waypoint")
}

}

function readFileAsString() {
    var files = this.files;
    var filename = files[0].name
    var namesplit = filename.split(".")
    var extension = namesplit[1]
if (extension == "fpl"){ 
    console.log(extension)
    if (files.length === 0) {
        console.log('No file is selected');
        return;
    }

    var reader = new FileReader();
    reader.onload = function(event) {
        //console.log('File content:', event.target.result);
        var n = event.target.result;
        //console.log(n);
        var parser, xmlDoc;
var table = "<tr><th>Name</th><th>Latitude</th><th>Longitude</th><th>Altitude</th><th>Type</th><th></th></tr>";
parser = new DOMParser();
xmlDoc = parser.parseFromString(n,"text/xml");

//console.log(xmlDoc)
x = xmlDoc.getElementsByTagName("waypoint").length;
//console.log(x)
i = 0
for(i = 0; i < x; i++){
wpt = xmlDoc.getElementsByTagName("waypoint")[i];
id = wpt.getElementsByTagName("identifier")[0].childNodes[0].nodeValue;
lat = Number(wpt.getElementsByTagName("lat")[0].childNodes[0].nodeValue);
lon = Number(wpt.getElementsByTagName("lon")[0].childNodes[0].nodeValue);
type = wpt.getElementsByTagName("type")[0].childNodes[0].nodeValue;
if (type == "USER WAYPOINT"){type = "USER"}
if (type == "INT"){type = "FIX"}
try{alt = Number(wpt.getElementsByTagName("elevation")[0].childNodes[0].nodeValue);
alt = alt*3.28084
alt = alt.toFixed(0);
}
catch(err){ alt = ""}
lat = lat.toFixed(7);
lon = lon.toFixed(7);
var r = i + 1
table += "<tr><td>" 
+ id 
+ "</td><td>" 
+ lat 
+ "</td><td>" 
+ lon 
+ "</td><td>" 
+ alt 
+ "</td><td>" 
+ type
+ "</td><td><button onclick= showEditor(" + r +") class = editbtn ><i class='fas fa-edit'></i> Edit</button>"
+ "</td></tr>"
}

document.getElementById("fpltable").innerHTML = table
};
   reader.readAsText(files[0]);
   
newfpladded()
}
else{
alert("Incorrect file format. Please upload a .fpl file")
}

}

function exportfpl(){

var fp = new FlightPlan("KSAN Circle");
var Wpts = document.getElementById("fpltable").rows.length
//console.log(Wpts)
var x = document.getElementById("fpltable")
//console.log(x.rows[1].cells[1].innerHTML)

var i = 1

for (i = 1; i < Wpts; i++){
var id = x.rows[i].cells[0].innerHTML
var lat = x.rows[i].cells[1].innerHTML
var lon = x.rows[i].cells[2].innerHTML
var alt = x.rows[i].cells[3].innerHTML
var type = x.rows[i].cells[4].innerHTML

if (type == "USER"){type = "USER WAYPOINT"}
if (type == "FIX"){type = "INT"}

fp.AddUserFix(id,lat,lon,alt,type);
}
fp.PrintXml();
}

// returns the angle between two headings
function AngleBetween(heading1,heading2){
  var h1=FixHeading(heading1);
  var h2=FixHeading(heading2);
  var delta=h1>h2?h1-h2:h2-h1;
  if (delta>180)
    delta=360-delta;
  //println("heading1="+heading1+" heading2="+heading2);
  //println("fxedheading1="+h1+" fixedheading2="+h2+" delta="+delta);
  return delta;
}

// returns degrees minutes (DDDMM) given decimal degrees (DD.dd)
function ToDegMin(num){
  var deg = Math.trunc(num);
  var min = Math.round(60*(num-deg));
  
  if (Math.abs(min)==60)
  {
    min=0;
    if (num < 0)
    {
      deg=deg-1;
    }
    else
    {
      deg=deg+1;
    }
  }
  
  /*
  println("debug ToDegMin")
  println("num="+num+" deg="+deg+" min="+min);
  println("end debug")
  */
  return deg*100 + min;
}

// converts lat lon in decimal degrees to DDMM[N/S]/DDDMM[E/W] format IF uses and prints the result
// lat is always entered as N (S is negative)
// lon is entered as E (west is negative)

// returns a longitude scaling factor for the given latitude. 
function LonMultiplier(latitude){
  return 1/Math.sin((90-latitude)*Math.PI*2/360);
}

// small headings around 0 are returned as 0
// headings larger than 360 are reduced to a value less than 360
// negative headings are converted to a positive number
function FixHeading(fixthis){
  var h = fixthis;
  if (Math.abs(h) < .1) 
    return 0;
  if ((Math.abs(h) / 360) >= 1)
    h = h % 360;
  if (h < 0)
  {
    return 360 + h;
  } 
  return h;
}

// given latitude and longitude (decimal degrees) heading and leg length, returns lat lon at the end of the leg
function NewPoint(latitude,longitude,heading,leglength){
  var lonScale = LonMultiplier(latitude);
  var alpha = Math.PI * 2 * (90 - heading)/360;

  var dx = lonScale * leglength * Math.cos(alpha);
  var deltaLon = dx / 60;
  var newLon = longitude + deltaLon;

  var dy = leglength * Math.sin(alpha);
  var deltaLat = dy / 60;
  var newLat = latitude + deltaLat;
  
  return [newLat,newLon];
}

function DistHeading(latfrom,lonfrom,latto,lonto){
   var lonMult = LonMultiplier((latfrom+latto)/2);
   var dy = (latto-latfrom)*60;
   var dx = ((lonto-lonfrom) / lonMult)*60;

   var dist = Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));
   if (dx==0)
      dx = .000001;
   var dyx=dy/dx;
   var angleRadians = Math.atan(dyx);
   var angleDegrees = angleRadians*180/Math.PI;
   var heading = FixHeading(90-angleDegrees); 
   if (dx<0)
     heading = 270-angleDegrees;

   return[dist,heading];
}

//XML stuff
class Node
{
  constructor(name,value,attribute)
  {
    this.Name = name; 
    this.Value = "";
    if (typeof(value) != "undefined")
      this.Value = value;
    this.Attribute = "";
    if (typeof(attribute)!="undefined")
      this.Attribute=" "+attribute;
    this.Children=[];
    this.Indent="";
    this.Version = "<?xml version=\"1.0\" encoding=\"utf-8\"?>";
  }
  AddChild(child)
  {
    child.Version="";
    child.Indent+=this.Indent+"  ";
    this.Children.push(child);
    return child;
  }
  Exists(name,value)
  {
    if (this.Name==name && this.Value==value)
      return true;
    var i=0;
    while(i<this.Children.length)
    {
      if (this.Children[i].Exists(name,value))
        return true;
      i++;
    }
    return false;
  }
  ToXML()
  {
    //println("building "+this.Name)
    var ret = this.Version;
    ret += this.BuildElement();
    var i=0;
    while (i<this.Children.length)
    {
       ret += this.Children[i].ToXML();
       i++;
    }
    if (this.Children.length!=0)
      ret+=this.Indent+"</"+this.Name+">\n";
    return ret;
  }
  BuildElement()
  {
    var el = this.Indent+"<"+this.Name+this.Attribute+">"+this.Value;
    if (this.Children.length==0)
      el += "</"+this.Name+">\n";
    else
      el += "\n";
    return el;
  }
}

class FlightPlan
{
  constructor(name)
  {
    this.Name=name;
    this.Fp = new Node("flight-plan","", "xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://www8.garmin.com/xmlschemas/FlightPlan/v1\"");
    this.WaypointTable = new Node("waypoint-table","");
    this.RouteTable = new Node("route","");
    this.Fp.AddChild(this.WaypointTable);
    this.Fp.AddChild(this.RouteTable);
  }
  AddUserFix(id,lat,lon,alt,type)
  {
    if (!this.WaypointTable.Exists("identifier",id))
    {
      var wp = new Node("waypoint","");
      this.WaypointTable.AddChild(wp);
      wp.AddChild(new Node("identifier",id));
      wp.AddChild(new Node("type",type));
      wp.AddChild(new Node("lat",lat));
      wp.AddChild(new Node("lon",lon));
      if (alt === ""){} else {
      alt = alt*0.3048
      alt = alt.toFixed(0);
      wp.AddChild(new Node("elevation",alt));
      }
    }
    var rt = new Node("route-point","");
    this.RouteTable.AddChild(rt);
    rt.AddChild(new Node("waypoint-identifier",id));
    rt.AddChild(new Node("waypoint-type",type));
  }
  PrintXml()
  {
var fplname = document.getElementById("filename").value + ".fpl";
    //console.log(this.Fp.ToXML());
    
    function download(filename, text) {

  var element = document.createElement('a');

  element.setAttribute('href', 'data:fpl/plain;charset=utf-8,' + encodeURIComponent(text));

  element.setAttribute('download', filename);
  element.style.display = 'none';

  document.body.appendChild(element);
  element.click();

  document.body.removeChild(element);

}
// Start file download.
download(fplname,this.Fp.ToXML());
}
}
</script>
</body>
</html>